# 🌟基本設計書

# 📋 1. システム概要

### 🎯 1.1 システムの目的と範囲

「カタワク」は、3Dプリンターの活用価値を「実用性」から「かわいさ」「おもしろさ」にシフトした日本初の感性志向型3Dモデル共有プラットフォームです。特に食品関連の型枠（クッキー型、チョコレート型など）に特化し、SNS映えする視覚的魅力のあるモデルを中心に提供するWebアプリケーションです。

本システムでは、ユーザーが3Dモデルの閲覧・検索、アップロード・ダウンロード、ユーザープロフィール管理などの機能を利用できます。システムはシンプルさを重視し、1人で運営可能な規模を維持しながらも、将来的な拡張性を考慮した設計とします。

### 🔧 1.2 システム構成の概要

「カタワク」のシステムは、以下の主要コンポーネントで構成されます。

- 🖥️ **フロントエンド**: Next.js 14を使用したSPA（Single Page Application）
- ⚙️ **バックエンド**: Supabaseを活用したサーバーレスアーキテクチャ
- 💾 **データストレージ**: Supabase PostgreSQLデータベースとStorage
- 🔐 **認証**: Google OAuth 2.0を利用したユーザー認証
- ☁️ **デプロイ環境**: Vercelホスティング

全体のアーキテクチャは、低運用コストと高いスケーラビリティを実現するために、可能な限りマネージドサービスを活用したサーバーレスアプローチを採用します。

```
+---------------------+     +---------------------+
|                     |     |                     |
|    クライアント      |     |      Vercel         |
|    (Webブラウザ)     +---->+    (Next.js 14)     |
|                     |     |                     |
+---------------------+     +----------+----------+
                                       |
                                       v
+---------------------+     +---------------------+
|                     |     |                     |
|  Google OAuth 2.0   +<--->+      Supabase       |
|                     |     |                     |
+---------------------+     +----------+----------+
                                       |
                              +--------+--------+
                              |                 |
                              |  PostgreSQL DB  |
                              |                 |
                              +-----------------+
```

### 🧩 2.1 コンポーネント詳細

### 🖼️ 2.2.1 フロントエンドコンポーネント

- 🎨 **UI層**: React コンポーネント、TailwindCSSによるスタイリング
- 🔄 **状態管理**: React Context API、SWR（データフェッチング）
- 🛣️ **ルーティング**: Next.js App Routerによるルーティング
- 🎮 **3Dモデルビューア**: Three.js / react-three-fiberによる3Dモデル表示

### ⚙️ 2.2.2 バックエンドコンポーネント

- 🔌 **API**: Supabase RESTful API、Next.js API Routes
- 🔐 **認証・認可**: Supabase Authentication、RLS（Row Level Security）
- 📦 **ストレージ**: Supabase Storageによるファイル管理
- 💾 **データベース**: Supabase PostgreSQL

### 🔗 2.2.3 外部連携コンポーネント

- 🔑 **認証連携**: Google OAuth 2.0
- 🖼️ **画像処理**: Vercel Image Optimization
- 📊 **アナリティクス**: Google Analytics
- 🌐 **CDN**: Vercel Edge Network

### 🛠️ 2.3 技術スタック詳細

### 💻 2.3.1 フロントエンド技術

- 🔧 **フレームワーク**: Next.js 14
- 🎭 **UIライブラリ**: React 18
- 🎨 **スタイリング**: TailwindCSS
- 🔄 **データフェッチング**: SWR
- 📝 **タイプチェック**: TypeScript

### ⚙️ 2.3.2 バックエンド技術

- 🌉 **APIプラットフォーム**: Supabase
- 🗄️ **データベース**: PostgreSQL
- 🧠 **サーバーサイドロジック**: Next.js API Routes
- 📦 **ストレージ**: Supabase Storage
- 🔐 **認証**: Supabase Auth

### ☁️ 2.3.3 インフラストラクチャ

- 🏠 **ホスティング**: Vercel
- 🔄 **CI/CD**: Vercel Git Integration
- 📈 **モニタリング**: Vercel Analytics
- 🌐 **ドメイン管理**: [お名前.com](http://xn--t8jx73hngb.com)（予定）

## 3. データベース設計

### 3.1 ER図

```
users                models
+------------+       +-------------+
| id         +-------+ id          |
| email      |       | user_id     |
| name       |       | title       |
| avatar_url |       | description |
| created_at |       | file_url    |
| updated_at |       | thumbnail_url|
+------------+       | created_at  |
                     | updated_at  |
                     +-------------+
```

### 3.2 テーブル定義

### 3.2.1 usersテーブル（ユーザー情報）

| カラム名 | データ型 | 制約 | 説明 |
| --- | --- | --- | --- |
| id | uuid | PRIMARY KEY | ユーザーID |
| email | text | NOT NULL, UNIQUE | メールアドレス |
| name | text | NOT NULL | 表示名 |
| avatar_url | text |  | プロフィール画像URL |
| created_at | timestamp | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | timestamp | NOT NULL, DEFAULT now() | 更新日時 |

### 3.2.2 modelsテーブル（3Dモデル情報）

| カラム名 | データ型 | 制約 | 説明 |
| --- | --- | --- | --- |
| id | uuid | PRIMARY KEY | モデルID |
| user_id | uuid | NOT NULL, REFERENCES users(id) | 投稿者ID |
| title | text | NOT NULL | モデル名 |
| description | text |  | モデル説明 |
| file_url | text | NOT NULL | モデルファイルURL |
| thumbnail_url | text |  | サムネイル画像URL |
| created_at | timestamp | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | timestamp | NOT NULL, DEFAULT now() | 更新日時 |

### 3.3 データベースセキュリティ（RLS）

Supabaseのデータベースセキュリティには、Row Level Security（RLS）を使用します。以下にテーブルごとのポリシーを定義します。

### 3.3.1 usersテーブルのRLSポリシー

```sql
-- 読み取りポリシー（全ユーザー情報は公開）
CREATE POLICY "ユーザー情報は全体に公開" ON users
    FOR SELECT USING (true);

-- 更新ポリシー（自分のプロフィールのみ更新可能）
CREATE POLICY "自分のプロフィールのみ更新可能" ON users
    FOR UPDATE USING (auth.uid() = id);
```

### 3.3.2 modelsテーブルのRLSポリシー

```sql
-- 読み取りポリシー（全モデルは公開）
CREATE POLICY "モデルは全体に公開" ON models
    FOR SELECT USING (true);

-- 挿入ポリシー（認証済みユーザーのみ）
CREATE POLICY "認証済みユーザーのみモデル追加可能" ON models
    FOR INSERT WITH CHECK (auth.uid() = user_id);

-- 更新・削除ポリシー（自分のモデルのみ）
CREATE POLICY "自分のモデルのみ更新可能" ON models
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "自分のモデルのみ削除可能" ON models
    FOR DELETE USING (auth.uid() = user_id);
```

### 4.認証時のユーザーフロー

1. **ユーザー認証フロー**:
    - ユーザーがアプリケーションにアクセスし、「Googleでログイン」ボタンをクリック。
    1. Googleの認証画面にリダイレクトされ、ユーザーは自身のGoogleアカウントで認証を行う。
    2. 認証成功後、Supabaseがユーザー情報を取得し、セッションを開始。
    3. ユーザーはアプリケーション内で認証済みの状態で操作を続ける。
2. **モデルアップロードフロー**:
    - ブラウザ → モデルデータ入力 → ファイル選択 → Next.js API → Supabase Storage （ファイル保存） → Supabase DB （メタデータ保存） → ブラウザ（完了通知）
3. **モデル一覧取得フロー**:
    - ブラウザ → APIクライアント → Supabase DB → モデル一覧データ → ブラウザ（表示）
4. **モデルダウンロードフロー**:
    - ブラウザ → ダウンロードボタンクリック → Supabase Storage → ファイルダウンロード

## 5. 画面遷移設計

### 5.1 画面遷移図

```
+----------------+                   +----------------+
|                |                   |                |
|   ホーム画面     +------------------>+  モデル詳細画面  |
|                |                   |                |
+----------------+                   +--------+-------+
                                             |
                                             |
                                             v
                                     +-------+--------+
                                     |                |
                                     |  ダウンロード    |
                                     |                |
                                     +----------------+

+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|   ログイン    　 +---->+  マイページ   　 +---->+ モデル投稿画面 　 |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+

```

               　　    

### 5.2 URLルーティング設計

| URL パス | 画面名 | 説明 |
| --- | --- | --- |
| / | ホーム画面 | トップページ、最新モデル表示 |
| /models/[id] | モデル詳細画面 | モデル詳細情報表示 |
| /auth/login | ログイン画面 | Google認証画面 |
| /auth/callback | 認証コールバック | 認証後のリダイレクト先 |
| /mypage | マイページ | ユーザープロフィール・投稿モデル |
| /upload | モデル投稿画面 | 新規モデル投稿フォーム |
| /models/[id]/edit | モデル編集画面 | モデル情報編集フォーム |