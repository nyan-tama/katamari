# カタマリ - ダウンロードパッケージと記事機能の要件定義

## 1. 機能概要

カタマリプラットフォームに「ダウンロードパッケージ」機能と、それに紐づく「記事/コンテンツ」機能を追加します。ダウンロードパッケージは作品（3Dモデルなど）に関連するファイル一式をまとめたものであり、記事はそれらの作品やパッケージの解説・紹介などのコンテンツとして機能します。これによりSEO効果を高め、ユーザーエンゲージメントを向上させます。

## 2. 目的と価値

### 2.1 導入目的

- **コンテンツ価値の向上**: 3Dモデルに加えて、ダウンロードパッケージと記事を提供し、総合的なコンテンツ価値を高める
- **SEO強化**: 記事コンテンツによりSEO効果を高め、ダウンロードパッケージへの流入を増加させる
- **ユーザーエンゲージメント向上**: コンテンツの多様化によりユーザーの滞在時間を延ばす
- **拡散性向上**: 記事形式のコンテンツにより、SNSで共有されやすいコンテンツを提供する

### 2.2 提供価値

- **包括的なコンテンツ提供**: 3Dモデル、関連ファイル一式、解説記事を一体的に提供
- **ユーザーの知識共有**: モデル制作のテクニック、3Dプリントのコツなどの知識共有
- **製作事例の紹介**: 完成品のファイル一式と製作プロセスの解説
- **モデル利用ガイド**: モデルの使い方、活用法の解説とファイル提供

## 3. 機能要件

### 3.1 ダウンロードパッケージ機能

- **パッケージ作成・管理**:
  - ファイルのアップロード（複数ファイル、フォルダ構造保持）
  - ファイル管理（追加、削除、更新）
  - パッケージのバージョン管理
  - パッケージ情報の編集（タイトル、説明、タグなど）
  
- **パッケージのダウンロード**:
  - ZIP形式での一括ダウンロード
  - 個別ファイルのダウンロード
  - ダウンロード統計の収集
  
- **パッケージと作品（3Dモデル）の連携**:
  - 既存モデルへのパッケージ紐付け
  - パッケージからモデルの閲覧

### 3.2 記事作成機能

- **リッチテキストエディタ**: Markdownベースのシンプルなエディタ
  - 見出し、リスト、太字、斜体などの基本的な書式設定
  - 画像のアップロードと挿入
    - ドラッグ＆ドロップによるアップロード
    - 画像の拡大・縮小機能
    - キャプション追加機能
  - リンクの挿入
  - YouTube動画の埋め込み
    - URLからの自動識別と埋め込み
    - プレビュー表示
  - 3Dモデルの埋め込み
    - 既存モデルの選択と埋め込み
    - インタラクティブ3Dビューワー付き表示
    
- **下書き保存**: 執筆中の記事を下書きとして保存
- **カバー画像設定**: 記事のヘッダー/OGP画像の設定
- **公開設定**: 公開/非公開の切り替え
- **パーマリンク設定**: 
  - 自動生成： `3d-printer-model-download-[uuid一部]` 形式
  - SEO最適化されたURL構造

### 3.3 記事・パッケージ表示機能

- **パッケージ詳細ページ**:
  - パッケージ内容の表示（ファイル一覧、サイズなど）
  - ダウンロードボタン
  - 関連モデルの表示
  - 関連記事へのリンク
  
- **記事詳細ページ**: 記事コンテンツの閲覧ページ
  - 著者情報の表示
  - 公開日時の表示
  - パッケージダウンロードへの明確な導線
  - 関連3Dモデルのプレビュー表示
  - 埋め込まれた3Dモデルのインタラクティブビューワー
  
- **一覧ページ**:
  - パッケージ一覧
  - 記事一覧
  - 最新コンテンツの表示
  - シンプルなページネーション

### 3.4 インタラクション機能

- **シェア機能**: SNS（Twitter, Facebook, LINE）での共有
- **パッケージダウンロード統計**: ダウンロード数のカウントと表示

### 3.5 ユーザープロフィール連携

- **作者ページ**: ユーザーが投稿したパッケージと記事の一覧表示
- **投稿数の表示**: プロフィールページに投稿数を表示

## 4. 非機能要件

### 4.1 パフォーマンス

- パッケージダウンロード速度の最適化
- 大容量ファイルの効率的な転送
- 記事ページの読み込み速度：2秒以内
- 画像の最適化：自動リサイズ、WebP形式変換
- 3Dモデルビューワーの最適化：モバイルデバイスでも軽快に動作

### 4.2 セキュリティ

- ファイルスキャン：アップロードされるファイルの安全性確認
- XSS対策：投稿内容のサニタイズ
- 権限管理：コンテンツの編集・削除権限の制限
- 3Dモデルファイルの安全チェック：マルウェア検出

## 5. データモデル

### 5.1 download_packagesテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | パッケージID |
| user_id | uuid | NOT NULL, REFERENCES users(id) | 作成者ID |
| title | text | NOT NULL | パッケージタイトル |
| description | text | | パッケージ説明 |
| folder_path | text | NOT NULL | ストレージ内のフォルダパス |
| size_bytes | bigint | NOT NULL | パッケージ合計サイズ（バイト） |
| download_count | integer | NOT NULL, DEFAULT 0 | ダウンロード数 |
| permalink | text | UNIQUE | カスタムURL |
| status | text | NOT NULL, DEFAULT 'active' | ステータス |
| created_at | timestamp | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | timestamp | NOT NULL, DEFAULT now() | 更新日時 |

### 5.2 package_modelsテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| package_id | uuid | NOT NULL, REFERENCES download_packages(id) | パッケージID |
| model_id | uuid | NOT NULL, REFERENCES models(id) | モデルID |
| created_at | timestamp | NOT NULL, DEFAULT now() | 作成日時 |

### 5.3 articlesテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | 記事ID |
| user_id | uuid | NOT NULL, REFERENCES users(id) | 投稿者ID |
| package_id | uuid | REFERENCES download_packages(id) | 関連パッケージID |
| title | text | NOT NULL | 記事タイトル |
| content | text | NOT NULL | 記事本文（Markdown形式） |
| cover_image_url | text | | カバー画像URL |
| permalink | text | UNIQUE | カスタムURL（`3d-printer-model-download-[uuid一部]`形式） |
| status | text | NOT NULL, DEFAULT 'draft' | 公開ステータス（'draft'/'published'） |
| published_at | timestamp | | 公開日時 |
| view_count | integer | NOT NULL, DEFAULT 0 | 閲覧数 |
| created_at | timestamp | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | timestamp | NOT NULL, DEFAULT now() | 更新日時 |

### 5.4 article_modelsテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| article_id | uuid | NOT NULL, REFERENCES articles(id) | 記事ID |
| model_id | uuid | NOT NULL, REFERENCES models(id) | モデルID |
| created_at | timestamp | NOT NULL, DEFAULT now() | 作成日時 |

### 5.5 article_embedded_modelsテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | uuid | PRIMARY KEY | 埋め込みモデルID |
| article_id | uuid | NOT NULL, REFERENCES articles(id) | 記事ID |
| model_id | uuid | REFERENCES models(id) | 既存モデルID |
| position | integer | NOT NULL | 記事内での表示順序 |
| created_at | timestamp | NOT NULL, DEFAULT now() | 作成日時 |

## 6. UI/UX設計方針

### 6.1 パッケージ管理画面

- ドラッグ＆ドロップによるファイルアップロード
- フォルダ構造の視覚化
- ファイル一覧の表示と管理
- パッケージ情報の編集インターフェース
- モデルとの関連付けUI

### 6.2 記事作成画面

- シンプルで直感的なエディタUI
- リアルタイムプレビュー表示
- ドラッグ&ドロップによる画像アップロード
- YouTube URLのペーストで自動プレビュー
- 3Dモデル検索・埋め込みインターフェース
- パーマリンクのプレビューと編集オプション
- 関連パッケージの選択UI

### 6.3 パッケージ詳細ページ

- 明確なダウンロードボタン
- ファイル一覧の表示
- パッケージ情報の表示
- 関連記事と3Dモデルへのリンク
- ダウンロード統計の表示

### 6.4 記事表示ページ

- 読みやすいタイポグラフィとレイアウト
- レスポンシブデザイン
- アイキャッチとなるカバー画像表示
- 著者情報の目立つ表示
- 関連パッケージへの明確な導線
- 関連3Dモデルのサムネイル表示
- シェアボタンの配置
- インタラクティブ3Dモデルビューワー

### 6.5 一覧ページ

- カード形式でのコンテンツ表示
- カバー画像、タイトル、抜粋、著者情報の表示
- フィルタリングオプション（パッケージ/記事/モデル）
- シンプルなページネーション

## 7. 開発計画

### 7.1 優先実装項目

以下の順序で機能を実装していきます：

1. **ダウンロードパッケージの基本機能**
   - パッケージテーブルの作成
   - ファイルアップロード機能
   - パッケージ情報管理機能
   - ダウンロード機能
   - 3Dモデルとの連携

2. **基本的な記事CRUD機能**
   - 記事テーブルの作成
   - 基本的な記事作成・編集・表示・削除機能
   - パーマリンク自動生成機能
   - パッケージとの連携機能

3. **リッチテキストエディタとメディア対応**
   - Markdownベースのエディタ実装
   - 画像アップロード機能
   - YouTube動画埋め込み機能

4. **3Dモデル連携の拡張**
   - 3Dモデルとの紐付け機能
   - 3Dモデル埋め込み機能
   - 3Dモデルビューワー実装

5. **シェア機能とUI/UX改善**
   - SNSシェアボタンの実装
   - OGP対応
   - デザインの改善
   - レスポンシブ対応の強化

### 7.2 スケジュール概要

| フェーズ | 期間 | 主な実装内容 |
|---------|------|------------|
| Phase 1 | 3週間 | ダウンロードパッケージ基本機能、データベース設計 |
| Phase 2 | 2週間 | 記事CRUD機能、パーマリンク、パッケージ連携 |
| Phase 3 | 2週間 | リッチテキストエディタ、メディア埋め込み機能 |
| Phase 4 | 2週間 | 3Dモデル連携強化、モデルビューワー |
| Phase 5 | 1週間 | シェア機能とOGP対応 |
| Phase 6 | 2週間 | UI/UX改善、テスト、バグ修正 |

## 8. 成功指標

この機能の成功を測るためには、以下の指標を活用します：

1. **パッケージ関連指標**:
   - 作成パッケージ数
   - ダウンロード数（総数、ユニークユーザー数）
   - パッケージあたりの平均ダウンロード数
   
2. **記事関連指標**:
   - 投稿記事数
   - 閲覧数
   - 記事からのパッケージダウンロード数（コンバージョン率）
   
3. **総合的指標**:
   - SEO効果（自然検索からの流入数）
   - 共有数（SNSでのシェア回数）
   - 滞在時間の変化
   - コンテンツあたりの平均エンゲージメント

## 9. 技術選定

### 9.1 ファイル管理

- Supabase Storageを利用
- ZIPファイル生成機能
- ストリーミングダウンロード対応

### 9.2 エディタコンポーネント

- **TipTap**: ProseMirrorベースのリッチテキストエディタ
  - React対応
  - モジュール式の拡張性
  - カスタマイズ性の高さ
  - 独自拡張機能の追加（YouTube埋め込み、3Dモデルビューワーなど）

### 9.3 画像/モデルアップロード・管理

- Supabase Storageを継続利用
- 画像最適化にNext.js Image Optimizationを活用
- 3Dモデルファイル用の専用バケット構成

### 9.4 マークダウンレンダリング

- remark/rehypeベースのレンダリングパイプライン
- シンタックスハイライトにPrismを使用
- カスタムコンポーネント（YouTube埋め込み、3Dモデルビューワー）のレンダリング
