# 要件定義書

## 1. 背景と目的

フェーズ2.5では、既存の記事テーブル構造を活かしつつ、最小限の記事投稿機能とダウンロードパッケージ機能を実装します。この段階では複雑なリッチテキストエディタ機能は省略し、シンプルな形で核となる機能を早期にリリースします。

## 2. 実装範囲と優先機能

### 2.1 最小限の記事投稿機能

- **シンプルな記事作成フォーム**
  - タイトル入力フィールド
  - 説明文用の単純なテキストエリア（リッチエディタではなく）
  - カバー/ヒーロー画像のアップロード
  - 公開/下書きステータス切り替え

- **記事管理機能**
  - 記事一覧表示
  - 記事詳細表示
  - 記事編集・削除
  - 公開/非公開切り替え

### 2.2 ダウンロードパッケージ機能

- **ファイルアップロード機能**
  - 複数ファイルのアップロード
  - 基本的なフォルダ構造の維持
  - ファイル名・サイズ表示

- **ダウンロード機能**
  - ZIP形式での一括ダウンロード
  - ダウンロード数のカウント

- **バリデーション**
  - ファイルタイプチェック
  - サイズ制限（最大50MB）
  - STLファイル必須チェック（3Dモデル関連記事の場合）

### 2.3 フェーズ3に延期する機能

- リッチテキストエディタ（TipTap）
- YouTube動画埋め込み
- 3Dモデルビューワーの埋め込み
- タグ機能
- 検索機能
- コメント機能
- 高度なファイル管理（バージョン管理など）

## 3. データモデル

既存のarticlesテーブルを中心としたデータモデルを維持しながら、ダウンロードファイル管理用のテーブルを拡張します。

### 3.1 articlesテーブル（既存）

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | uuid | PRIMARY KEY |
| title | text | 記事タイトル |
| content | text | 記事内容（現段階では単純なテキスト） |
| status | text | 記事ステータス（'draft'/'published'） |
| user_id | uuid | 作成者ID |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |
| published_at | timestamp | 公開日時 |
| hero_image_id | uuid | ヒーロー画像ID |

### 3.2 download_filesテーブル（新規）

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | uuid | PRIMARY KEY |
| article_id | uuid | 関連記事ID |
| file_name | text | ファイル名 |
| file_path | text | ストレージ内のパス |
| file_size | bigint | ファイルサイズ（バイト） |
| mime_type | text | ファイルタイプ |
| download_count | integer | ダウンロード数 |
| created_at | timestamp | 作成日時 |
| updated_at | timestamp | 更新日時 |

### 3.3 article_mediaテーブル（既存・拡張）

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | uuid | PRIMARY KEY |
| article_id | uuid | 関連記事ID |
| media_type | text | メディアタイプ（'image', 'video', '3d_model'） |
| storage_bucket | text | ストレージバケット名 |
| storage_path | text | ストレージ内のパス |
| media_role | text | メディアの役割（'hero', 'content', 'download'） |
| created_at | timestamp | 作成日時 |

## 4. UI/UX設計

### 4.1 記事作成/編集画面

- **記事情報セクション**
  - タイトル入力
  - 説明文テキストエリア
  - ヒーロー画像アップロード
  - 公開/下書きトグル

- **ダウンロードファイルセクション**
  - ファイルアップロードエリア（ドラッグ＆ドロップ対応）
  - アップロード済みファイル一覧
  - 個別ファイル削除ボタン

- **フッター操作**
  - キャンセルボタン
  - 保存ボタン

### 4.2 記事詳細画面

- **記事コンテンツ表示**
  - ヒーロー画像
  - タイトル
  - 作成者情報
  - 公開日
  - 説明文テキスト

- **ダウンロードセクション**
  - ファイル一覧表示
  - ファイル情報（名前、サイズ）
  - 一括ダウンロードボタン
  - ダウンロード数表示

## 5. 実装のポイント

### 5.1 ファイルアップロード実装

- **フロントエンド**
  - React Dropzoneによるドラッグ＆ドロップ
  - アップロード進捗表示
  - エラーハンドリングとユーザーフィードバック

- **バックエンド**
  - Supabase Storageを使用
  - 記事ID別のフォルダ構造
  - ファイルメタデータの保存

### 5.2 ダウンロード機能実装

- **Zipファイル生成**
  - サーバーサイドでの一時的なZip生成
  - 大容量ファイル対応のストリーミング
  - CORSに注意した実装

- **ダウンロードカウンター**
  - アトミックな更新処理
  - 重複カウント防止策

### 5.3 最低限の記事機能

- **シンプルなエディタ**
  - テキストエリアベースの実装
  - 基本的なバリデーション
  - Markdown記法の部分的サポート（オプション）

## 6. 開発スケジュール

| 作業項目 | 期間 | 内容 |
|---------|------|------|
| DB設計 | 2日 | テーブル定義、RLS設定 |
| 記事基本機能 | 3日 | 最小限の記事CRUD |
| ファイルアップロード | 4日 | 複数ファイルアップロード、メタデータ保存 |
| ダウンロード機能 | 3日 | Zip生成、ダウンロードカウント |
| UI実装 | 3日 | フロントエンド画面実装 |
| テスト・調整 | 2日 | 機能テスト、バグ修正 |

**合計期間：約2週間**

## 7. 評価指標

フェーズ2.5実装の成功を測る指標：

1. **機能完成度**
   - 記事作成・編集・表示の基本機能
   - ファイルアップロード・ダウンロードの基本機能

2. **性能指標**
   - アップロード時間（5MB以下のファイルで3秒以内）
   - ダウンロード開始までの時間（3秒以内）

3. **ユーザーフィードバック**
   - 基本機能の使いやすさ
   - エラー発生頻度 