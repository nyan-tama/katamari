# 詳細設計書

## 1.テーブル設計

### テーブル作成SQL

```sql
-- usersテーブル作成
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  avatar_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- modelsテーブル作成
CREATE TABLE models (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  file_url TEXT NOT NULL,
  thumbnail_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- インデックス作成
CREATE INDEX idx_models_user_id ON models(user_id);
CREATE INDEX idx_models_created_at ON models(created_at);

-- 更新日時を自動更新する関数とトリガー
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
   NEW.updated_at = now();
   RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();

CREATE TRIGGER update_models_updated_at
BEFORE UPDATE ON models
FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();
```

### RLS（Row Level Security）ポリシー詳細

```sql
-- usersテーブルのRLSを有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- usersテーブルのポリシー
-- 全てのユーザー情報は誰でも閲覧可能
CREATE POLICY "ユーザーの閲覧は全体に公開" ON users
    FOR SELECT USING (true);

-- 自分のプロフィールのみ更新可能
CREATE POLICY "自分のプロフィールのみ更新可能" ON users
    FOR UPDATE USING (auth.uid() = id);

-- modelsテーブルのRLSを有効化
ALTER TABLE models ENABLE ROW LEVEL SECURITY;

-- modelsテーブルのポリシー
-- 全てのモデルは誰でも閲覧可能
CREATE POLICY "モデルの閲覧は全体に公開" ON models
    FOR SELECT USING (true);

-- 認証済みユーザーのみモデル追加可能
CREATE POLICY "認証済みユーザーのみモデル追加可能" ON models
    FOR INSERT WITH CHECK (auth.uid() = user_id);

-- 自分のモデルのみ更新可能
CREATE POLICY "自分のモデルのみ更新可能" ON models
    FOR UPDATE USING (auth.uid() = user_id);

-- 自分のモデルのみ削除可能
CREATE POLICY "自分のモデルのみ削除可能" ON models
    FOR DELETE USING (auth.uid() = user_id);
```

### ストレージバケット設定

```sql
-- モデルファイル用のバケット作成
CREATE STORAGE bucket models;

-- サムネイル画像用のバケット作成
CREATE STORAGE bucket thumbnails;

-- ストレージのRLSポリシー
-- 閲覧はすべてのユーザーに許可
CREATE POLICY "モデルファイルは全体に公開" ON storage.objects
    FOR SELECT USING (bucket_id = 'models');

CREATE POLICY "サムネイルは全体に公開" ON storage.objects
    FOR SELECT USING (bucket_id = 'thumbnails');

-- アップロードは認証済みユーザーのみ許可
CREATE POLICY "認証済みユーザーのみモデルファイルのアップロード可能" ON storage.objects
    FOR INSERT WITH CHECK (
        bucket_id = 'models' AND
        auth.role() = 'authenticated'
    );

CREATE POLICY "認証済みユーザーのみサムネイルのアップロード可能" ON storage.objects
    FOR INSERT WITH CHECK (
        bucket_id = 'thumbnails' AND
        auth.role() = 'authenticated'
    );

-- 削除は所有者のみ許可（オブジェクトURLに所有者IDを含める命名規則を前提とします）
CREATE POLICY "所有者のみモデルファイルの削除可能" ON storage.objects
    FOR DELETE USING (
        bucket_id = 'models' AND
        auth.uid()::text = (storage.foldername(name))[1]
    );

CREATE POLICY "所有者のみサムネイルの削除可能" ON storage.objects
    FOR DELETE USING (
        bucket_id = 'thumbnails' AND
        auth.uid()::text = (storage.foldername(name))[1]
    );
```

## 2.フロントエンド詳細設計

### 2.1 ディレクトリ構造

```sql
/
├── app/                     # Next.js App Router
│   ├── (auth)/              # 認証関連ルート
│   │   ├── login/           # ログインページ
│   │   └── callback/        # 認証コールバックページ
│   ├── models/              # モデル関連ルート
│   │   ├── [id]/            # モデル詳細ページ
│   │   └── [id]/edit/       # モデル編集ページ
│   ├── profile/             # プロフィールページ
│   ├── upload/              # モデルアップロードページ
│   ├── layout.tsx           # ルートレイアウト
│   ├── page.tsx             # ホームページ
│   └── providers.tsx        # コンテキストプロバイダー
├── api/                     # API Routes
│   └── v1/                  # APIバージョン
│       ├── models/          # モデル関連API
│       └── users/           # ユーザー関連API
├── components/              # 共通コンポーネント
│   ├── ui/                  # 基本UI要素
│   ├── auth/                # 認証関連コンポーネント
│   ├── layout/              # レイアウト関連コンポーネント
│   └── models/              # モデル表示関連コンポーネント
├── hooks/                   # カスタムフック
├── lib/                     # ユーティリティ関数
│   └── supabase/            # Supabase関連機能
├── public/                  # 静的ファイル
│   ├── images/              # 画像ファイル
│   └── models/              # サンプル3Dモデル
├── styles/                  # スタイル関連
├── types/                   # TypeScript型定義
├── .env.local.example       # 環境変数サンプル
├── .eslintrc.js             # ESLint設定
├── .gitignore               # Git除外設定
├── next.config.js           # Next.js設定
├── package.json             # パッケージ情報
├── postcss.config.js        # PostCSS設定
├── tailwind.config.js       # Tailwind設定
└── tsconfig.json            # TypeScript設定
```

## 2.クラス図とシーケンス図

```sql
+-------------------+        +---------------------+
|      User         |        |       Model         |
+-------------------+        +---------------------+
| id: UUID          |<-------| id: UUID            |
| email: string     |        | user_id: UUID       |
| name: string      |        | title: string       |
| avatar_url: string|        | description: string |
| created_at: Date  |        | file_url: string    |
| updated_at: Date  |        | thumbnail_url: string|
+-------------------+        | created_at: Date    |
| updateProfile()   |        | updated_at: Date    |
+-------------------+        +---------------------+
        ^                    | upload()            |
        |                    | update()            |
        |                    | delete()            |
        |                    | download()          |
        |                    +---------------------+
        |                              ^
        |                              |
+-------------------+        +---------------------+
|   AuthService     |        |    ModelService     |
+-------------------+        +---------------------+
| user: User        |        | getModels()         |
| loading: boolean  |        | getModelById()      |
+-------------------+        | uploadModel()       |
| signIn()          |        | updateModel()       |
| signOut()         |        | deleteModel()       |
| getSession()      |        | downloadModel()     |
+-------------------+        +---------------------+
        ^                              ^
        |                              |
        |                              |
        |                              |
+-------------------+        +---------------------+
|    AuthHook       |        |     ModelHook       |
+-------------------+        +---------------------+
| useAuth()         |        | useModels()         |
+-------------------+        | useModelById()      |
                             | useModelUpload()    |
                             +---------------------+
```

### シーケンス図

### 2.1 ユーザー認証シーケンス図

```sql
+---------+    +----------+    +-----------+    +-----------+    +--------+
| Browser |    | Next.js  |    | Supabase  |    |  Google   |    |  DB    |
+---------+    +----------+    +-----------+    +-----------+    +--------+
     |              |               |                |               |
     | 1. アクセス    |               |                |               |
     |------------->|               |                |               |
     |              |               |                |               |
     | 2. ページ表示  |               |                |               |
     |<-------------|               |                |               |
     |              |               |                |               |
     | 3. ログインボタンクリック |     |                |               |
     |------------->|               |                |               |
     |              |               |                |               |
     |              | 4. 認証リクエスト|                |               |
     |              |-------------->|                |               |
     |              |               |                |               |
     |              |               | 5. OAuth リダイレクト |          |
     |              |               |--------------->|               |
     |              |               |                |               |
     | 6. Google認証画面表示 |        |                |               |
     |<-------------------------------------------- |               |
     |              |               |                |               |
     | 7. 認証情報入力 |               |                |               |
     |-------------------------------------------->|               |
     |              |               |                |               |
     |              |               | 8. 認証コード     |               |
     |              |               |<---------------|               |
     |              |               |                |               |
     |              |               | 9. トークン生成   |               |
     |              |               |---------------------------->|  |
     |              |               |                |               |
     |              |               | 10. ユーザー情報 |               |
     |              |               |<----------------------------|  |
     |              |               |                |               |
     | 11. コールバックURLへリダイレクト |  |                |               |
     |<-------------|<--------------|                |               |
     |              |               |                |               |
     | 12. ログイン状態表示 |          |                |               |
     |<-------------|               |                |               |
     |              |               |                |               |
```

### 2.2 モデルアップロードシーケンス図

```sql
+---------+    +----------+    +-----------+    +--------+
| Browser |    | Next.js  |    | Supabase  |    |  DB    |
+---------+    +----------+    +-----------+    +--------+
     |              |               |               |
     | 1. アップロード画面アクセス |   |               |
     |------------->|               |               |
     |              |               |               |
     | 2. アップロードフォーム表示 |    |               |
     |<-------------|               |               |
     |              |               |               |
     | 3. モデルファイル、メタデータ入力 |   |               |
     |------------->|               |               |
     |              |               |               |
     |              | 4. ファイルアップロードリクエスト |      |
     |              |-------------->|               |
     |              |               |               |
     |              |               | 5. ストレージにファイル保存 |
     |              |               |-------------->|
     |              |               |               |
     |              |               | 6. ファイルURL  |
     |              |               |<--------------|
     |              |               |               |
     |              | 7. モデルメタデータ保存リクエスト |     |
     |              |-------------->|               |
     |              |               |               |
     |              |               | 8. DBにメタデータ保存 |
     |              |               |-------------->|
     |              |               |               |
     |              |               | 9. 保存結果    |
     |              |               |<--------------|
     |              |               |               |
     |              | 10. アップロード結果 |            |
     |              |<--------------|               |
     |              |               |               |
     | 11. 完了メッセージ表示 |         |               |
     |<-------------|               |               |
     |              |               |               |
```